const { Octokit } = require('@octokit/rest');
const fs = require('fs');
const path = require('path');

const octokit = new Octokit({
  auth: process.env.GITHUB_TOKEN,
});

const HATHOR_CORE_REPO = {
  owner: 'HathorNetwork',
  repo: 'hathor-core',
};

const OUTPUT_FILE = path.resolve(__dirname, '../lib/hathor-modules.ts');
const PACKAGE_JSON_FILE = path.resolve(__dirname, '../package.json');

function getHathorCoreReference() {
  const packageJson = JSON.parse(fs.readFileSync(PACKAGE_JSON_FILE, 'utf8'));
  return packageJson['hathor-core-reference'];
}

async function getTree(sha) {
  const { data: treeData } = await octokit.git.getTree({
    ...HATHOR_CORE_REPO,
    tree_sha: sha,
    recursive: 1,
  });
  return treeData.tree;
}

function filterHathorModules(tree) {
  return tree
    .map(item => item.path)
    .filter(path => path.startsWith('hathor/'))
    .filter(path => path.endsWith('.py') || path.endsWith('.yml'));
}

function generateFileContent(modules) {
  const header = `/**
 * Hardcoded list of all Hathor modules to avoid GitHub API rate limits
 * This list was generated by scanning the hathor-core repository
 * Total: ${modules.length} Python modules
 */`;

  const modulesString = modules.map(m => `  '${m}'`).join(',\n');
  const exportStatement = `export const HATHOR_MODULES = [\n${modulesString},\n] as const;`;

  return `${header}\n${exportStatement}\n`;
}

async function main() {
  try {
    console.log('Reading hathor-core-reference from package.json...');
    const hathorCoreReference = getHathorCoreReference();
    if (!hathorCoreReference) {
      throw new Error('hathor-core-reference not found in package.json');
    }
    console.log(`Hathor Core Reference: ${hathorCoreReference}`);

    console.log('Fetching git tree...');
    const tree = await getTree(hathorCoreReference);
    console.log(`Found ${tree.length} total files.`);

    console.log('Filtering Hathor modules...');
    const hathorModules = filterHathorModules(tree);
    console.log(`Found ${hathorModules.length} Hathor modules.`);

    console.log('Generating file content...');
    const fileContent = generateFileContent(hathorModules);

    console.log(`Writing to ${OUTPUT_FILE}...`);
    fs.writeFileSync(OUTPUT_FILE, fileContent);

    console.log('âœ… Hathor modules list updated successfully!');
  } catch (error) {
    console.error('Error updating Hathor modules list:', error);
    process.exit(1);
  }
}

main();
